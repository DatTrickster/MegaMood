name: Discord notification on commit

on:
  push:
    branches: [main, master]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_NOTIFICATIONS }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          AUTHOR: ${{ github.event.head_commit.author.name }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_NOTIFICATIONS secret is not set; skipping notification."
            exit 0
          fi
          PAYLOAD=$(node -e "
            const msg = (process.env.COMMIT_MSG || '').slice(0, 500).replace(/\n/g, ' ');
            const sha = (process.env.COMMIT_SHA || '').slice(0, 7);
            const url = process.env.COMMIT_URL || '';
            const payload = {
              embeds: [{
                title: 'New commit',
                description: '**' + process.env.REPO + '** (\`' + process.env.BRANCH + '\`)',
                color: 16744448,
                fields: [
                  { name: 'Message', value: msg || '(no message)', inline: false },
                  { name: 'Author', value: process.env.AUTHOR || 'â€”', inline: true },
                  { name: 'Commit', value: '[\`' + sha + '\`](' + url + ')', inline: true }
                ],
                timestamp: new Date().toISOString()
              }]
            };
            console.log(JSON.stringify(payload));
          ")
          curl -s -S -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
